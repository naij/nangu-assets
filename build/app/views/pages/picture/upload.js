define("app/views/pages/picture/upload",["magix","jquery"],function(i,a,e){var t=i("magix"),l=i("jquery");e.exports=t.View.extend({tmpl:'<div class="picture-upload"><div class="dialog-hd"><h2 class="dialog-title">\u56fe\u7247\u4e0a\u4f20</h2></div><div class="dialog-bd"><ul class="preview-cnt clearfix">{{#for(item in pics)}}<li><div class="pic-cnt"><img src="{{item.filePath}}"/></div><div class="meta"><div class="progress progress{{__index__}}"></div>{{item.fileSize}}</div></li>{{/for}}</ul><div class="pic-upload-input"><input type="file" name="upload" id="J_upload" multiple="multiple" mx-change="fileChange()"/></div></div><div class="dialog-ft"><a href="javascript:;" class="btn btn-brand btn-large mr10" mx-click="upload()" t-if="fileList.length > 0">\u4e0a\u4f20</a><a href="javascript:;" class="btn btn-disabled btn-large mr10" t-if="fileList.length == 0">\u4e0a\u4f20</a><a href="javascript:;" class="btn btn-normal btn-large" mx-click="cancel()">\u53d6\u6d88</a></div></div>',init:function(i){this.extraData=i},render:function(){var i=this;i.data={fileList:[]},i.setView()},picPreview:function(i){for(var a=this,e=i.length,t=[],l=0;e>l;l++){var n=i[l],s={};if(n){s.fileSize=n.size>1048576?(Math.round(100*n.size/1048576)/100).toString()+"MB":(Math.round(100*n.size/1024)/100).toString()+"KB"}if(0==n.type.indexOf("image")){var r=new FileReader;r.readAsDataURL?r.readAsDataURL(n):r.readAsDataurl&&r.readAsDataurl(n),function(i,l){r.onload=function(n){i.filePath=n.target.result,t.push(i),l==e-1&&(a.data={pics:t},a.setView())}}(s,l)}}},uploadFile:function(){function i(){if(s<r.length&&s!=r.length){var i=new FormData;i.append("pic",r[s]);var l=new XMLHttpRequest;l.upload.addEventListener("progress",a,!1),l.addEventListener("load",e,!1),l.open("POST","/api/tool/pic/create.json?_csrf="+t.config("csrf")),l.send(i)}}function a(i){if(i.lengthComputable){var a=Math.round(100*i.loaded/i.total),e=l(".progress"+s);e.html('<div style="width:'+a.toString()+'%;"></div>')}}function e(){s++,i(),s==r.length&&(n.extraData.dialog.close(),n.extraData.callback())}var n=this,s=0,r=n.data.fileList;i()},"fileChange<change>":function(){var i=l("#J_upload")[0].files;i.length>0&&(this.data.fileList=i,this.setView(),this.picPreview(i))},"upload<click>":function(i){i.preventDefault(),this.uploadFile()},"cancel<click>":function(i){i.preventDefault(),this.extraData.dialog.close()}})});