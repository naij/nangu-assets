define("app/views/pages/activity/create",["magix","jquery","app/coms/editor/editor","app/mixins/dialog"],function(i,t,e){var a=i("magix"),s=i("jquery"),l=i("app/coms/editor/editor"),c=i("app/mixins/dialog");e.exports=a.View.extend({tmpl:{html:'<div class="page-header clearfix"><div class="title-bar"><h2 class="title" t-if="id">\u7f16\u8f91\u6d3b\u52a8</h2><h2 class="title" t-if="!id">\u65b0\u589e\u6d3b\u52a8</h2></div></div><div class="page-body activity-create"><div class="draft-tip" t-if="hasDraft">\b<p class="bd">\u7cfb\u7edf\u68c0\u6d4b\u5230\u4f60\u6709\u4e00\u4efd\u7f16\u8f91\u4e2d\u7684\u8349\u7a3f\uff0c\u662f\u5426\u9700\u8981\u8986\u76d6\u5f53\u524d\u5185\u5bb9\uff1f</p><div><a href="#" class="btn btn-green btn-large mr10" mx-click="loaddraft()">\u8986\u76d6</a><a href="#" class="btn btn-normal btn-large" mx-click="canceldraft()">\u4e0d\u7528</a></div></div><form id="activity-create-form"><input mx-guid="gb" type="hidden" name="type" value="1"><ul class="union-form"><li class="field"><p class="field-label2">\u6807\u9898</p><input mx-guid="gf" type="text" class="input" name="title" value="{{title}}"></li><li class="field"><p class="field-label2">\u4ef7\u683c</p><input mx-guid="g12" type="text" class="input" name="price" value="{{price}}"></li><li class="field"><p class="field-label2">\u5730\u7406\u4f4d\u7f6e</p><input mx-guid="g15" type="text" class="input" name="location" value="{{location}}"></li><li class="field"><p class="field-label2">\u5730\u7406\u4f4d\u7f6e\u7ecf\u7eac\u5ea6</p><input mx-guid="g18" type="text" class="input" name="longitudeAndlatitude" value="{{longitudeAndlatitude}}"></li><li class="field"><p class="field-label2">\u5730\u7406\u4f4d\u7f6e\u622a\u56fe</p><div class="location-cover clearfix">{{^if(locationCover)}}<div class="img-placeholder" mx-click="pickLocationCover()"><span class="iconfont iconhao"></span><div>\u6dfb\u52a0\u5730\u7406\u4f4d\u7f6e\u622a\u56fe</div></div>{{/if}} {{#if(locationCover)}}<div class="img-container"><div class="mask" mx-click="pickLocationCover()">\u91cd\u65b0\u9009\u62e9\u56fe\u7247</div><img mx-guid="g21" src="{{locationCover}}" class="img"> <input mx-guid="g22" type="hidden" name="locationCover" value="{{locationCover}}"></div>{{/if}}</div></li><li class="field"><p class="field-label2">\u5c01\u9762\u56fe</p><div class="cover clearfix">{{^if(cover)}}<div class="img-placeholder" mx-click="pickCover()"><span class="iconfont iconhao"></span><div>\u6dfb\u52a0\u5c01\u9762</div></div>{{/if}} {{#if(cover)}}<div class="img-container"><div class="mask" mx-click="pickCover()">\u91cd\u65b0\u9009\u62e9\u56fe\u7247</div><img mx-guid="g2b" src="{{cover}}" class="img"> <input mx-guid="g2c" type="hidden" name="cover" value="{{cover}}"></div>{{/if}}</div></li><li class="field"><p class="field-label2">\u8f6e\u64ad\u56fe</p><div class="slide clearfix">{{#if(slide.length > 0)}} {{#for(item in slide)}}<div class="img-container"><div class="mask" mx-click="pickSlide({index:{{__INDEX__}}})">\u91cd\u65b0\u9009\u62e9\u56fe\u7247</div><img mx-guid="g32" src="{{item}}" class="img"> <input mx-guid="g33" type="hidden" name="slide[{{__INDEX__}}]" value="{{item}}"></div>{{/for}} {{/if}} {{^if(slide.length >= 2)}}<div class="img-placeholder" mx-click="pickSlide()"><span class="iconfont iconhao"></span><div>\u6dfb\u52a0\u8f6e\u64ad\u56fe</div></div>{{/if}}</div></li><li class="field"><p class="field-label2">\u8d39\u7528\u8bf4\u660e</p><div id="cost-description-editor"></div></li><li class="field"><p class="field-label2">\u8d39\u7528\u5305\u542b</p><div id="cost-include-editor"></div></li><li class="field"><p class="field-label2">\u4f7f\u7528\u65b9\u6cd5</p><div id="usage-editor"></div></li><li class="field"><p class="field-label2">\u6ce8\u610f\u4e8b\u9879</p><div id="notice-editor"></div></li><li class="field"><p class="field-label2">\u4ea7\u54c1\u8bf4\u660e</p><div id="description-editor"></div></li><li class="field"><a href="#" class="btn btn-brand btn-large mr10" mx-click="submit()">\u53d1\u5e03</a><a href="#" class="btn btn-brand btn-large" mx-click="draft()">\u4fdd\u5b58\u6210\u8349\u7a3f</a></li></ul></form></div>',subs:[]},mixins:[c],render:function(){var i=this,t=i.param("id");""!==t?i.request().all([{name:"activity_detail",params:{id:t}}],function(e,a){var s=a.get("data");i.data=s,i.data.id=t,s.draft&&1==s.status&&(i.data.hasDraft=!0),i.setView().then(function(){i._rendered(s)})}):(i.data={title:"",price:"",location:"",longitudeAndlatitude:"",locationCover:"",cover:"",slide:[],costDescription:"",costInclude:"",usage:"",notice:"",description:""},i.setView().then(function(){i._rendered()}))},_rendered:function(i){var t=new l("#cost-description-editor");this._customInsertImg(t),t.create();var e=new l("#cost-include-editor");this._customInsertImg(e),e.create();var a=new l("#usage-editor");this._customInsertImg(a),a.create();var s=new l("#notice-editor");this._customInsertImg(s),s.create();var c=new l("#description-editor");this._customInsertImg(c),c.create(),this.costDescriptionEditor=t,this.costIncludeEditor=e,this.usageEditor=a,this.noticeEditor=s,this.descriptionEditor=c,i&&this._setEditorContent(i)},_setEditorContent:function(i){this.costDescriptionEditor.txt.html(i.costDescription),this.costIncludeEditor.txt.html(i.costInclude),this.usageEditor.txt.html(i.usage),this.noticeEditor.txt.html(i.notice),this.descriptionEditor.txt.html(i.description)},_customInsertImg:function(i){var t=this;i.customConfig.onInsertImg=function(i){t.mxDialog("app/views/pages/common/imgpicker",{width:700,limit:1,callback:function(t){i(t[0].picPath)}})}},_getEditorContent:function(){var i=this,t={};return t.costDescription=i.costDescriptionEditor.txt.html().replace(/[\r\n]/g,"").replace(/<style(([\s\S])*?)<\/style>/g,"").replace(/\<img/gi,'<img style="width:100%;height:auto" ').replace(/<p>/gi,'<p class="p_class">'),t.costInclude=i.costIncludeEditor.txt.html().replace(/[\r\n]/g,"").replace(/<style(([\s\S])*?)<\/style>/g,"").replace(/\<img/gi,'<img style="width:100%;height:auto" ').replace(/<p>/gi,'<p class="p_class">'),t.usage=i.usageEditor.txt.html().replace(/[\r\n]/g,"").replace(/<style(([\s\S])*?)<\/style>/g,"").replace(/\<img/gi,'<img style="width:100%;height:auto" ').replace(/<p>/gi,'<p class="p_class">'),t.notice=i.noticeEditor.txt.html().replace(/[\r\n]/g,"").replace(/<style(([\s\S])*?)<\/style>/g,"").replace(/\<img/gi,'<img style="width:100%;height:auto" ').replace(/<p>/gi,'<p class="p_class">'),t.description=i.descriptionEditor.txt.html().replace(/[\r\n]/g,"").replace(/<style(([\s\S])*?)<\/style>/g,"").replace(/\<img/gi,'<img style="width:100%;height:auto" ').replace(/<p>/gi,'<p class="p_class">'),t},"pickLocationCover<click>":function(i){i.preventDefault();var t=this;t.mxDialog("app/views/pages/common/imgpicker",{width:700,limit:1,callback:function(i){t.data.locationCover=i[0].picPath,t.setView()}})},"pickCover<click>":function(i){i.preventDefault();var t=this;t.mxDialog("app/views/pages/common/imgpicker",{width:700,limit:1,callback:function(i){t.data.cover=i[0].picPath,t.setView()}})},"pickSlide<click>":function(i){i.preventDefault();var t=this,e=i.params.index;t.mxDialog("app/views/pages/common/imgpicker",{width:700,limit:1,callback:function(i){"undefined"!=typeof e?t.data.slide.splice(e,1,i[0].picPath):t.data.slide.push(i[0].picPath),t.setView()}})},"submit<click>":function(i){i.preventDefault();var t=this,e=t.data.id,l=s("#activity-create-form").serializeJSON({useIntKeysAsArrayIndex:!0}),c=t._getEditorContent();a.mix(l,c),l.draft="",l.status=1;var d;"undefined"==typeof e?d="activity_create":(l.id=e,d="activity_update"),t.request().all([{name:d,params:l}],function(){t.to("/activity/list")})},"draft<click>":function(i){i.preventDefault();var t=this,e=t.data.id,l=t.data.status||2,c={},d=s("#activity-create-form").serializeJSON({useIntKeysAsArrayIndex:!0}),n=t._getEditorContent();1==l?c=t.data:(c.status=l,a.mix(c,d),a.mix(c,n)),c.draft=JSON.stringify(d);var r;"undefined"==typeof e?r="activity_create":(c.id=e,r="activity_update"),t.request().all([{name:r,params:c}],function(i,e){t.alert("\u8349\u7a3f\u4fdd\u5b58\u6210\u529f\uff01"),t.data.id=e.get("data").id})},"loaddraft<click>":function(i){i.preventDefault();var t=this.data;this.data=a.mix(t,JSON.parse(t.draft)),this.data.hasDraft=!1,this.setView(),this._setEditorContent(this.data),this.alert("\u5df2\u7528\u8349\u7a3f\u5185\u5bb9\u8986\u76d6\u5f53\u524d\u5185\u5bb9\uff01")},"canceldraft<click>":function(i){i.preventDefault(),this.data.hasDraft=!1,this.setView()}})});